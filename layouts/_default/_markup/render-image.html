{{ $src := .Destination }}
{{ $alt := .Text }}
{{ $caption := .Title }}

{{ $image := .Page.Resources.GetMatch $src }}
{{ if not $image }}
  {{ $image = resources.Get $src }}
{{ end }}

{{ if $image }}
  {{ $small := $image.Resize "480x" }}
  {{ $medium := $image.Resize "768x" }}
  {{ $large := $image.Resize "1024x" }}

  <figure>
    <img
      srcset="{{ $small.RelPermalink }} 480w,
              {{ $medium.RelPermalink }} 768w,
              {{ $large.RelPermalink }} 1024w,
              {{ $image.RelPermalink }} {{ $image.Width }}w"
      sizes="(max-width: 480px) 480px,
             (max-width: 768px) 768px,
             (max-width: 1024px) 1024px,
             {{ $image.Width }}px"
      src="{{ $image.RelPermalink }}"
      width="{{ $image.Width }}"
      height="{{ $image.Height }}"
      alt="{{ $alt }}"
      loading="lazy"
    >
    {{ with $caption }}
    <figcaption>{{ . }}</figcaption>
    {{ end }}
  </figure>
{{ else }}
  <p>Image not found: {{ $src }}</p>
{{ end }}
